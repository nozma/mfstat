name: Build Desktop Apps

on:
  workflow_dispatch:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  macos_arm64:
    name: macOS arm64
    runs-on: macos-15
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Verify macOS architecture
        run: |
          arch="$(uname -m)"
          if [ "$arch" != "arm64" ]; then
            echo "Expected arm64 runner, got: $arch" >&2
            exit 1
          fi

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Create backend virtualenv
        run: python -m venv backend/.venv

      - name: Build macOS distributable
        run: make build-macos

      - name: Upload macOS arm64 archive
        uses: actions/upload-artifact@v4
        with:
          name: MFStat-macos-arm64
          path: backend/dist/MFStat-macos-arm64.zip
          if-no-files-found: error

  macos_intel:
    name: macOS x86_64
    runs-on: macos-13
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Verify macOS architecture
        run: |
          arch="$(uname -m)"
          if [ "$arch" != "x86_64" ]; then
            echo "Expected x86_64 runner, got: $arch" >&2
            exit 1
          fi

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Create backend virtualenv
        run: python -m venv backend/.venv

      - name: Build macOS distributable
        run: make build-macos

      - name: Upload macOS x86_64 archive
        uses: actions/upload-artifact@v4
        with:
          name: MFStat-macos-x86_64
          path: backend/dist/MFStat-macos-x86_64.zip
          if-no-files-found: error

  windows_x64:
    name: Windows x64
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Install frontend dependencies
        run: npm ci --prefix frontend

      - name: Create backend virtualenv
        run: python -m venv backend/.venv

      - name: Build Windows distributable
        shell: pwsh
        run: .\scripts\build_windows.ps1

      - name: Upload Windows archive
        uses: actions/upload-artifact@v4
        with:
          name: MFStat-windows-x64
          path: backend/dist/MFStat-windows-x64.zip
          if-no-files-found: error

  release:
    name: Publish Release Assets
    if: startsWith(github.ref, 'refs/tags/v')
    needs: [macos_arm64, macos_intel, windows_x64]
    runs-on: ubuntu-latest
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-assets
          merge-multiple: true

      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: release-assets/*.zip
          generate_release_notes: true
